"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[7631],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),h=c(n),u=r,m=h["".concat(o,".").concat(u)]||h[u]||d[u]||l;return n?a.createElement(m,s(s({ref:t},p),{},{components:n})):a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,s=new Array(l);s[0]=u;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[h]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<l;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2622:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const l={},s="Ansible Cheat Sheet",i={unversionedId:"cheat-sheets/ansible",id:"cheat-sheets/ansible",title:"Ansible Cheat Sheet",description:"Debugging",source:"@site/docs/cheat-sheets/ansible.md",sourceDirName:"cheat-sheets",slug:"/cheat-sheets/ansible",permalink:"/docs/cheat-sheets/ansible",draft:!1,editUrl:"https://github.com/agarthetiger/docusaurus/tree/main/docs/cheat-sheets/ansible.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Cheat Sheets",permalink:"/docs/category/cheat-sheets"},next:{title:"Jenkins",permalink:"/docs/cheat-sheets/jenkins"}},o={},c=[{value:"Debugging",id:"debugging",level:2},{value:"Print hostvars",id:"print-hostvars",level:3},{value:"Flow control",id:"flow-control",level:2},{value:"Loops",id:"loops",level:2},{value:"Blocks",id:"blocks",level:2},{value:"Process files on host",id:"process-files-on-host",level:2},{value:"Documentation",id:"documentation",level:2}],p={toc:c};function h(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"ansible-cheat-sheet"},"Ansible Cheat Sheet"),(0,r.kt)("h2",{id:"debugging"},"Debugging"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"{{ inventory_hostname }}")," The inventory name for the current host being iterated over in the task. One of Ansible's ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html"},"Special Variables"),"."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"{{ ansible_facts }}")," Dictionary of facts gathered or cached for the ",(0,r.kt)("inlineCode",{parentName:"p"},"inventory_hostname"),".  "),(0,r.kt)("h3",{id:"print-hostvars"},"Print hostvars"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"- name: print hostvars\n  debug: \n    var: hostvars[inventory_hostname]\n    # This is the same as {{ ansible_facts }} but note that ansible_facts will work differntly to hostvars[inventory_hostname] when delegating actions to another host.\n    verbosity: 2\n")),(0,r.kt)("p",null,"Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"hostvars[inventory_hostname]")," will always give the facts for the specified inventory_hostname, whereas ansible_facts gives it for the machine the task is being run on. This behaviour will be apparent when delegating tasks to other machines, especially localhost which will not have had any facts gathered at all. "),(0,r.kt)("h2",{id:"flow-control"},"Flow control"),(0,r.kt)("p",null,"Run a single task in serial in a Role. Note that the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html"},"serial keyword")," is not applicable to a task, so we have to use a workaround with a side-effect which is that the host selected by Ansible to execute the run_once task will report as being changed even when the actual change took place on the host which the task was delegated to. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'- name: Enable and start the service\n  service:\n    name: my_service\n    enabled: yes\n    state: started\n  delegate_to: "{{ item }}"  \n  run_once: true\n  loop: "{{ ansible_play_batch }}"\n')),(0,r.kt)("h2",{id:"loops"},"Loops"),(0,r.kt)("p",null,"Loops work with ",(0,r.kt)("inlineCode",{parentName:"p"},"when")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"failed_when")," as well as the ",(0,r.kt)("inlineCode",{parentName:"p"},"until")," conditions. ",(0,r.kt)("inlineCode",{parentName:"p"},"when")," will be evaluated once prior to entering the loop, ",(0,r.kt)("inlineCode",{parentName:"p"},"until")," will be evaluated as the loop repetition condition and finally the ",(0,r.kt)("inlineCode",{parentName:"p"},"failed_when")," condition will be evaluated a single time only once the until condition is true or the loop has reached the maximum ",(0,r.kt)("inlineCode",{parentName:"p"},"retry")," limit."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'  - name: Poll for Cassandra connection\n    shell: "echo \'SHOW HOST;\' | cqlsh {{ ansible_default_ipv4.address }} -u \'cassandra\' --ssl"\n    register: result\n    until: result.stderr.find("Connection refused") == -1\n    retries: 10\n    delay: 10 \n    changed_when: false\n    failed_when: result.stderr.find("Connection refused") != -1\n')),(0,r.kt)("h2",{id:"blocks"},"Blocks"),(0,r.kt)("p",null,"Block sections include ",(0,r.kt)("inlineCode",{parentName:"p"},"block"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"rescue")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"always"),". These function like ",(0,r.kt)("inlineCode",{parentName:"p"},"try"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"catch")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"finally")," respectively. Blocks can accept options like run_once and tags, note that they can't be used to apply handlers which must be specified per task."),(0,r.kt)("h2",{id:"process-files-on-host"},"Process files on host"),(0,r.kt)("p",null,"The find module can be used to find files on a remote host and then process them in later in the playbook by registering the output. The full filename and path is stored in the registered variable under files.path, which can be looped over as per the example below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'- name: find all logstash plugins\n  find:\n    paths: "{{ logstash_plugins_folder }}"\n    patterns: "*.gem"\n    recurse: no\n  register: plugin_gems\n  changed_when: no\n\n- name: ensure all plugins are installed\n  logstash_plugin:\n    name: "{{ item.path }}"\n    state: present\n  loop: "{{ plugin_gems.files }}"\n  notify: restart logstash\n')),(0,r.kt)("h2",{id:"documentation"},"Documentation"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html"},"Special Variables")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html"},"Keywords")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html"},"Filters")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://jinja.palletsprojects.com/en/2.10.x/templates/#builtin-filters"},"Jinja2 Filters"))))}h.isMDXComponent=!0}}]);